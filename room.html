<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä</title>
  <style>
    :root {
      --primary-color: #4f46e5;
      --primary-light: #6366f1;
      --primary-dark: #4338ca;
      --secondary-color: #64748b;
      --light-bg: #f8fafc;
      --card-bg: #ffffff;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --border-radius: 12px;
      --shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      --shadow-hover: 0 10px 15px rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
      background: var(--light-bg);
      margin: 0;
      padding: 20px;
      color: #334155;
      line-height: 1.6;
      touch-action: manipulation;
    }
    
    h2 {
      text-align: center;
      margin-bottom: 25px;
      font-size: clamp(24px, 5vw, 32px);
      background: var(--gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 800;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
      align-items: center;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid #e2e8f0;
    }
    
    .controls label {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      font-weight: 500;
      color: #475569;
    }
    
    select, button, input {
      font-size: 16px;
      padding: 12px 15px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background: #ffffff;
      color: #334155;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
      min-height: 44px;
      transition: all 0.2s ease;
      -webkit-appearance: none;
      appearance: none;
    }
    
    select:focus, input:focus {
      outline: 2px solid var(--primary-color);
      outline-offset: 2px;
      border-color: var(--primary-color);
    }
    
    #newRoomName {
      flex-grow: 1;
      min-width: 200px;
    }
    
    button {
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      white-space: nowrap;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      user-select: none;
    }
    
    button:active {
      transform: translateY(0);
      box-shadow: var(--shadow);
    }
    
    .primary-btn {
      background: var(--primary-color);
      color: #fff;
    }
    
    .primary-btn:hover {
      background: var(--primary-dark);
    }
    
    .secondary-btn {
      background: var(--secondary-color);
      color: #fff;
    }
    
    .export-btn {
      background: var(--success-color);
      color: #fff;
    }
    
    .rename-btn {
      background: var(--warning-color);
      color: #fff;
    }
    
    .cleaning-btn {
      background: var(--info-color);
      color: #fff;
    }
    
    .stats {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      min-width: 150px;
      text-align: center;
      flex: 1;
      transition: transform 0.2s;
      border-top: 4px solid var(--primary-color);
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .stat-card div {
      font-size: clamp(20px, 4vw, 28px);
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
      justify-content: center;
      background: var(--card-bg);
      padding: 20px;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow);
      border: 1px solid #e2e8f0;
    }
    
    .filters input, .filters select {
      flex: 1;
      min-width: 180px;
    }
    
    .calendar-container {
      overflow-x: auto;
      border-radius: var(--border-radius);
      background: #ffffff;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      -webkit-overflow-scrolling: touch;
      position: relative;
      border: 1px solid #e2e8f0;
    }
    
    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 800px;
    }
    
    th, td {
      border: 1px solid #e2e8f0;
      text-align: center;
      padding: 8px;
      font-size: 14px;
      height: 40px;
      position: relative;
      touch-action: manipulation;
    }
    
    th {
      background: #f1f5f9;
      position: sticky;
      top: 0;
      z-index: 2;
      font-weight: 600;
      color: #1e293b;
    }
    
    .room-name {
      background: #f8fafc;
      font-weight: bold;
      position: sticky;
      left: 0;
      z-index: 1;
      cursor: pointer;
      transition: background 0.2s;
      min-width: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 15px;
      height: 40px;
      user-select: none;
      text-align: center;
    }
    
    .room-name:hover {
      background: #e0f2fe;
    }
    
    .room-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: normal;
      color: #64748b;
      width: 100%;
    }
    
    .cell {
      cursor: pointer;
      transition: background 0.2s;
      min-width: 40px;
      position: relative;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      -webkit-touch-callout: none;
    }
    
    .cell:active {
      background: #e0f2fe !important;
    }
    
    .cell:hover {
      background: #f0f9ff;
    }
    
    .occupied {
      color: #fff;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer !important;
    }
    
    .occupied.paid-fully {
      background: var(--success-color);
    }
    
    .occupied.paid-partial {
      background: var(--warning-color);
    }
    
    .occupied.not-paid {
      background: var(--danger-color);
    }
    
    .occupied.cancelled {
      background: #94a3b8;
    }
    
    .occupied.maintenance {
      background: #94a3b8;
    }
    
    .occupied span {
      display: block;
      font-size: 11px;
      line-height: 1.2;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      pointer-events: none;
    }
    
    .room-color-0 { color: #dc2626; }
    .room-color-1 { color: #16a34a; }
    .room-color-2 { color: #2563eb; }
    .room-color-3 { color: #d97706; }
    .room-color-4 { color: #7c3aed; }
    .room-color-5 { color: #059669; }
    .room-color-6 { color: #be123c; }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10;
      padding: 15px;
      backdrop-filter: blur(3px);
    }
    
    .modal-content {
      background: #ffffff;
      padding: 25px;
      width: 100%;
      max-width: 500px;
      border-radius: var(--border-radius);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    
    .modal-close {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #64748b;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      padding: 0;
    }
    
    .modal-close:hover {
      background: #f1f5f9;
      color: #334155;
    }
    
    .modal-content h3 {
      margin-top: 0;
      color: var(--primary-color);
      padding-right: 30px;
      font-size: clamp(18px, 4vw, 22px);
    }
    
    .modal-content input, .modal-content select {
      width: 100%;
      padding: 12px;
      margin: 10px 0;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .modal-content button {
      width: 48%;
      padding: 12px;
      border: none;
      color: #fff;
      margin-top: 15px;
      cursor: pointer;
      border-radius: 8px;
      font-weight: bold;
    }
    
    .modal-content .save {
      background: var(--success-color);
    }
    
    .modal-content .delete {
      background: var(--danger-color);
    }
    
    .modal-buttons {
      display: flex;
      justify-content: space-between;
      gap: 10px;
    }
    
    .repeat-options {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 8px;
    }
    
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success-color);
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      max-width: 300px;
      animation: slideIn 0.3s ease;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .backup-controls {
      text-align: center;
      margin: 20px 0;
      display: flex;
      gap: 15px;
      justify-content: center;
      flex-wrap: wrap;
    }
    
    .backup-controls button {
      margin: 0;
    }
    
    .financial-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .financial-stat {
      background: #f8fafc;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      border-left: 4px solid var(--primary-color);
    }
    
    .financial-stat h4 {
      margin: 0 0 8px 0;
      font-size: 14px;
      color: #64748b;
    }
    
    .financial-stat div {
      font-size: 20px;
      font-weight: bold;
      color: var(--primary-color);
    }
    
    .financial-inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 20px;
    }
    
    .cleaning-indicator {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 8px;
      height: 8px;
      background: var(--danger-color);
      border-radius: 50%;
    }
    
    .payment-status {
      font-size: 9px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      pointer-events: none;
    }
    
    .room-number {
      font-size: clamp(12px, 3vw, 14px);
      font-weight: bold;
      text-align: center;
      width: 100%;
      padding: 0 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* –ú–æ–±–∏–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      h2 {
        margin-bottom: 15px;
      }
      
      .controls, .filters {
        flex-direction: column;
        align-items: stretch;
        padding: 15px;
        gap: 10px;
      }
      
      .controls label, .filters label {
        width: 100%;
      }
      
      select, button, input {
        width: 100%;
        margin: 0;
        font-size: 16px;
        padding: 10px 12px;
        min-height: 44px;
      }
      
      button {
        min-height: 44px;
        padding: 10px 12px;
      }
      
      .stats {
        flex-direction: column;
        gap: 10px;
      }
      
      .stat-card {
        width: 100%;
        max-width: 100%;
        padding: 15px;
      }
      
      .modal-content {
        padding: 20px;
        margin: 10px;
        max-height: 85vh;
      }
      
      .modal-buttons {
        flex-direction: column;
        gap: 10px;
      }
      
      .modal-content button {
        width: 100%;
        margin-top: 5px;
        padding: 12px;
        min-height: 44px;
      }
      
      .modal-close {
        width: 40px;
        height: 40px;
        top: 10px;
        right: 10px;
      }
      
      th, td {
        padding: 4px;
        font-size: 12px;
        height: 35px;
        min-width: 35px;
      }
      
      .occupied span {
        font-size: 9px;
      }
      
      .financial-inputs {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      
      .backup-controls {
        flex-direction: column;
        align-items: stretch;
      }
      
      .backup-controls button {
        width: 100%;
      }
      
      .room-name {
        min-width: 120px;
        padding: 0 8px;
      }
      
      .room-number {
        font-size: 11px;
      }
      
      .payment-status {
        font-size: 8px;
      }
    }
    
    @media (max-width: 480px) {
      .calendar-container {
        margin-left: -10px;
        margin-right: -10px;
        width: calc(100% + 20px);
        border-radius: 0;
        border-left: none;
        border-right: none;
      }
      
      th, td {
        padding: 3px;
        font-size: 11px;
        height: 32px;
        min-width: 32px;
      }
      
      .room-name {
        min-width: 100px;
        padding: 0 5px;
      }
      
      .cell {
        min-width: 32px;
      }
      
      .modal-content {
        padding: 15px;
      }
      
      .stat-card h3 {
        font-size: 12px;
      }
      
      .stat-card div {
        font-size: 18px;
      }
    }
    
    @media (max-width: 360px) {
      th, td {
        padding: 2px;
        font-size: 10px;
        height: 30px;
        min-width: 30px;
      }
      
      .room-name {
        min-width: 90px;
        font-size: 10px;
      }
      
      .cell {
        min-width: 30px;
      }
    }
    
    /* –¢–∞–±–ª–µ—Ç–∫–∏ */
    @media (min-width: 769px) and (max-width: 1024px) {
      .container {
        padding: 0 10px;
      }
      
      .controls, .filters {
        padding: 15px;
        gap: 12px;
      }
      
      select, button, input {
        padding: 10px 12px;
        font-size: 15px;
      }
      
      th, td {
        padding: 6px;
        font-size: 13px;
        height: 38px;
      }
      
      .room-name {
        min-width: 150px;
        padding: 0 10px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <h2>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∫–≤–∞—Ä—Ç–∏—Ä</h2>

  <div class="controls">
    <label>–ì–æ–¥:
      <select id="yearSelect"></select>
    </label>
    <label>–ú–µ—Å—è—Ü:
      <select id="monthSelect">
        <option value="0">–Ø–Ω–≤–∞—Ä—å</option><option value="1">–§–µ–≤—Ä–∞–ª—å</option>
        <option value="2">–ú–∞—Ä—Ç</option><option value="3">–ê–ø—Ä–µ–ª—å</option>
        <option value="4">–ú–∞–π</option><option value="5">–ò—é–Ω—å</option>
        <option value="6">–ò—é–ª—å</option><option value="7">–ê–≤–≥—É—Å—Ç</option>
        <option value="8">–°–µ–Ω—Ç—è–±—Ä—å</option><option value="9">–û–∫—Ç—è–±—Ä—å</option>
        <option value="10">–ù–æ—è–±—Ä—å</option><option value="11">–î–µ–∫–∞–±—Ä—å</option>
      </select>
    </label>
    <input id="newRoomName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã" />
    <button class="primary-btn" onclick="addRoom()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
    <button class="rename-btn" onclick="openRenameModal()">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
    <button class="cleaning-btn" onclick="markCleaningNeeded()">üßπ –û—Ç–º–µ—Ç–∏—Ç—å —É–±–æ—Ä–∫—É</button>
    <button class="export-btn" onclick="exportToCSV()">üì• –≠–∫—Å–ø–æ—Ä—Ç –≤ CSV</button>
  </div>

  <div class="filters">
    <input id="searchRoom" placeholder="üîç –ü–æ–∏—Å–∫ –∫–≤–∞—Ä—Ç–∏—Ä—ã" oninput="filterRooms()">
    <select id="statusFilter" onchange="filterRooms()">
      <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="free">–°–≤–æ–±–æ–¥–Ω—ã–µ</option>
      <option value="booked">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
      <option value="cleaning">–¢—Ä–µ–±—É—é—Ç —É–±–æ—Ä–∫–∏</option>
    </select>
    <select id="categoryFilter" onchange="filterRooms()">
      <option value="all">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      <option value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç</option>
      <option value="luxury">–õ—é–∫—Å</option>
      <option value="family">–°–µ–º–µ–π–Ω—ã–π</option>
    </select>
  </div>

  <div class="stats">
    <div class="stat-card">
      <h3>–ó–∞–≥—Ä—É–∑–∫–∞</h3>
      <div id="occupancyRate">0%</div>
    </div>
    <div class="stat-card">
      <h3>–û–∂–∏–¥–∞–µ–º—ã–π –¥–æ—Ö–æ–¥</h3>
      <div id="expectedIncome">0 ‚ÇΩ</div>
    </div>
    <div class="stat-card">
      <h3>–ë—Ä–æ–Ω–µ–π</h3>
      <div id="totalBookings">0</div>
    </div>
    <div class="stat-card">
      <h3>–¢—Ä–µ–±—É—é—Ç —É–±–æ—Ä–∫–∏</h3>
      <div id="cleaningCount">0</div>
    </div>
  </div>

  <div class="backup-controls">
    <button class="secondary-btn" onclick="createBackup()">üíæ –°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é</button>
    <button class="secondary-btn" onclick="restoreBackup()">üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ –∫–æ–ø–∏–∏</button>
    <button class="secondary-btn" onclick="exportToGoogleCalendar()">üìÖ –≠–∫—Å–ø–æ—Ä—Ç –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å</button>
  </div>

  <div class="calendar-container">
    <table id="calendarTable">
      <thead><tr><th class="room-name">–ö–≤–∞—Ä—Ç–∏—Ä–∞</th></tr></thead>
      <tbody id="calendarBody"></tbody>
    </table>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal" id="bookingModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeBookingModal()">√ó</button>
    <h3>–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
    <input id="guestName" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
    <input id="guestPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω">
    <input id="nightsCount" type="number" placeholder="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π" min="1">
    <input id="totalPrice" type="number" placeholder="–û–±—â–∞—è —Å—É–º–º–∞ (‚ÇΩ)">
    <input id="paidAmount" type="number" placeholder="–û–ø–ª–∞—á–µ–Ω–æ (‚ÇΩ)">

    <div id="remainingAmount" style="margin-top:5px;font-weight:bold;color:#1e40af;">
      –û—Å—Ç–∞–ª–æ—Å—å: 0
    </div>

    <div style="margin: 10px 0; padding: 10px; background: #f8fafc; border-radius: 8px;">
      <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: var(--danger-color); border-radius: 4px;"></div>
          <span style="font-size: 12px;">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: var(--warning-color); border-radius: 4px;"></div>
          <span style="font-size: 12px;">–ß–∞—Å—Ç–∏—á–Ω–æ</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: var(--success-color); border-radius: 4px;"></div>
          <span style="font-size: 12px;">–ü–æ–ª–Ω–æ—Å—Ç—å—é</span>
        </div>
      </div>
    </div>

    <select id="bookingStatus">
      <option value="confirmed">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ</option>
      <option value="pending">–û–∂–∏–¥–∞–Ω–∏–µ</option>
      <option value="deposit">–î–µ–ø–æ–∑–∏—Ç</option>
      <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
      <option value="maintenance">–¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ</option>
    </select>

    <input id="dateFrom" type="date">
    <input id="dateTo" type="date">
    
    <label style="display: flex; align-items: center; gap: 8px; margin: 10px 0;">
      <input type="checkbox" id="repeatBooking" onchange="toggleRepeatOptions()">
      <span>–ü–æ–≤—Ç–æ—Ä—è—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</span>
    </label>
    
    <div class="repeat-options" id="repeatOptions">
      <select id="repeatType">
        <option value="weekly">–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ</option>
        <option value="monthly">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</option>
        <option value="yearly">–ï–∂–µ–≥–æ–¥–Ω–æ</option>
      </select>
      <select id="repeatCount">
        <option value="1">1 —Ä–∞–∑</option>
        <option value="2">2 —Ä–∞–∑–∞</option>
        <option value="4">4 —Ä–∞–∑–∞</option>
        <option value="12">12 —Ä–∞–∑</option>
      </select>
    </div>
    
    <div class="modal-buttons">
      <button class="save" onclick="saveBooking()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="delete" onclick="deleteBooking()">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è -->
<div class="modal" id="renameModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeRenameModal()">√ó</button>
    <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä—É</h3>
    <select id="roomSelect" style="margin-bottom: 15px;"></select>
    <input id="newRoomNameInput" placeholder="–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã">
    <div class="modal-buttons">
      <button class="save" onclick="renameSelectedRoom()">üíæ –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
      <button class="delete" onclick="closeRenameModal()">‚ùå –û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- –û–∫–Ω–æ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
<div class="modal" id="financialModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeFinancialModal()">√ó</button>
    <h3 id="selectedRoomName">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ</h3>
    <div class="financial-stats">
      <div class="financial-stat">
        <h4>–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏</h4>
        <div id="purchasePrice">0 ‚ÇΩ</div>
      </div>
      <div class="financial-stat">
        <h4>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –≤—Å–µ–≥–æ</h4>
        <div id="totalEarned">0 ‚ÇΩ</div>
      </div>
      <div class="financial-stat">
        <h4>–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</h4>
        <div id="monthEarned">0 ‚ÇΩ</div>
      </div>
      <div class="financial-stat">
        <h4>–†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å</h4>
        <div id="profitability">0%</div>
      </div>
    </div>
    <div class="financial-inputs">
      <div>
        <label for="roomPurchasePrice">–°—Ç–æ–∏–º–æ—Å—Ç—å –ø–æ–∫—É–ø–∫–∏ (‚ÇΩ)</label>
        <input type="number" id="roomPurchasePrice" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å">
      </div>
      <div>
        <label for="roomTargetProfit">–¶–µ–ª–µ–≤–∞—è –ø—Ä–∏–±—ã–ª—å (‚ÇΩ)</label>
        <input type="number" id="roomTargetProfit" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–µ–≤—É—é –ø—Ä–∏–±—ã–ª—å">
      </div>
    </div>
    <button class="primary-btn" onclick="saveRoomFinancialInfo()" style="margin-top: 15px; width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</button>
  </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö
let rooms = JSON.parse(localStorage.getItem('rooms') || '[]');
if (rooms.length === 0) {
  rooms = Array.from({ length: 15 }, (_, i) => ({
    name: `–ê–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã ‚Ññ${101 + i}`,
    category: i < 10 ? 'standard' : (i < 13 ? 'luxury' : 'family'),
    price: i < 10 ? 2500 : (i < 13 ? 5000 : 3500),
    capacity: i < 10 ? 2 : (i < 13 ? 4 : 6),
    amenities: ['wifi', 'tv'],
    purchasePrice: 0,
    targetProfit: 0,
    totalEarned: 0,
    monthEarned: 0,
    needsCleaning: false
  }));
}

const monthSel = document.getElementById('monthSelect');
const yearSel = document.getElementById('yearSelect');
const table = document.getElementById('calendarTable');
const calendarBody = document.getElementById('calendarBody');
const bookingModal = document.getElementById('bookingModal');
const renameModal = document.getElementById('renameModal');
const financialModal = document.getElementById('financialModal');

let bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
let activeCell = null;
let activeMonth = new Date().getMonth();
let activeYear = new Date().getFullYear();
let selectedRoomIndex = -1;

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
function init() {
  populateYears();
  drawCalendar();
  calculateStats();
  checkUpcomingBookings();
  
  // –ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  if ('Notification' in window && Notification.permission === 'default') {
    Notification.requestPermission();
  }
}

function populateYears() {
  const y = new Date().getFullYear();
  yearSel.innerHTML = '';
  for (let i = y - 5; i <= y + 5; i++) {
    const opt = document.createElement('option');
    opt.value = i;
    opt.textContent = i;
    yearSel.appendChild(opt);
  }
  yearSel.value = activeYear;
  monthSel.value = activeMonth;
}

function drawCalendar(m = activeMonth, y = activeYear) {
  activeMonth = +m;
  activeYear = +y;
  const days = new Date(y, activeMonth + 1, 0).getDate();
  
  // –û—á–∏—â–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Å–æ–∑–¥–∞–µ–º –∑–∞–Ω–æ–≤–æ
  const thead = table.querySelector('thead');
  thead.innerHTML = '<tr><th class="room-name">–ö–≤–∞—Ä—Ç–∏—Ä–∞</th></tr>';
  
  // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –≤ –∑–∞–≥–æ–ª–æ–≤–æ–∫
  for (let d = 1; d <= days; d++) {
    const th = document.createElement('th');
    th.textContent = d.toString().padStart(2, '0');
    thead.querySelector('tr').appendChild(th);
  }

  // –û—á–∏—â–∞–µ–º —Ç–µ–ª–æ —Ç–∞–±–ª–∏—Ü—ã
  calendarBody.innerHTML = '';
  
  // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
  for (let i = 0; i < rooms.length; i++) {
    const room = rooms[i];
    const tr = document.createElement('tr');
    
    // –Ø—á–µ–π–∫–∞ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã
    const nameTd = document.createElement('td');
    nameTd.className = `room-name room-color-${i % 7}`;
    
    const roomInfoDiv = document.createElement('div');
    roomInfoDiv.className = 'room-info';
    
    const roomNameSpan = document.createElement('span');
    roomNameSpan.className = 'room-number';
    roomNameSpan.textContent = room.name;
    
    roomInfoDiv.appendChild(roomNameSpan);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —É–±–æ—Ä–∫–∏
    if (room.needsCleaning) {
      const cleaningIndicator = document.createElement('div');
      cleaningIndicator.className = 'cleaning-indicator';
      roomInfoDiv.appendChild(cleaningIndicator);
    }
    
    nameTd.appendChild(roomInfoDiv);
    nameTd.onclick = () => showRoomFinancialInfo(i);
    tr.appendChild(nameTd);
    
    // –°–æ–∑–¥–∞–µ–º —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π
    for (let d = 1; d <= days; d++) {
      const cell = document.createElement('td');
      cell.className = 'cell';
      cell.dataset.room = i;
      cell.dataset.day = d;
      cell.dataset.month = activeMonth;
      cell.dataset.year = activeYear;
      
      // –ü–†–û–°–¢–û–ô –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
      cell.onclick = function() {
        console.log('–ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ', this.dataset);
        openBookingModal(this);
      };
      
      tr.appendChild(cell);
    }
    
    calendarBody.appendChild(tr);
  }

  paintBookings();
  calculateStats();
  initDragAndDrop();
}

function addRoom() {
  const name = document.getElementById('newRoomName').value.trim();
  if (!name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–≤–∞—Ä—Ç–∏—Ä—ã');
  
  rooms.push({
    name: name,
    category: 'standard',
    price: 2500,
    capacity: 2,
    amenities: ['wifi', 'tv'],
    purchasePrice: 0,
    targetProfit: 0,
    totalEarned: 0,
    monthEarned: 0,
    needsCleaning: false
  });
  
  localStorage.setItem('rooms', JSON.stringify(rooms));
  document.getElementById('newRoomName').value = '';
  drawCalendar();
  showNotification('–ö–≤–∞—Ä—Ç–∏—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞');
}

function openRenameModal() {
  const roomSelect = document.getElementById('roomSelect');
  roomSelect.innerHTML = '';
  
  rooms.forEach((room, index) => {
    const option = document.createElement('option');
    option.value = index;
    option.textContent = room.name;
    roomSelect.appendChild(option);
  });
  
  renameModal.style.display = 'flex';
}

function closeRenameModal() {
  renameModal.style.display = 'none';
}

function renameSelectedRoom() {
  const roomIndex = document.getElementById('roomSelect').value;
  const newName = document.getElementById('newRoomNameInput').value.trim();
  
  if (!newName) {
    alert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–≤–∞—Ä—Ç–∏—Ä—ã');
    return;
  }
  
  rooms[roomIndex].name = newName;
  localStorage.setItem('rooms', JSON.stringify(rooms));
  drawCalendar();
  closeRenameModal();
  showNotification('–ö–≤–∞—Ä—Ç–∏—Ä–∞ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∞');
}

function showRoomFinancialInfo(index) {
  selectedRoomIndex = index;
  const room = rooms[index];
  
  document.getElementById('selectedRoomName').textContent = `–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–≤–∞—Ä—Ç–∏—Ä–µ: ${room.name}`;
  document.getElementById('purchasePrice').textContent = `${room.purchasePrice || 0} ‚ÇΩ`;
  document.getElementById('totalEarned').textContent = `${room.totalEarned || 0} ‚ÇΩ`;
  document.getElementById('monthEarned').textContent = `${room.monthEarned || 0} ‚ÇΩ`;
  
  const profitability = room.purchasePrice ? ((room.totalEarned || 0) / room.purchasePrice * 100).toFixed(1) : 0;
  document.getElementById('profitability').textContent = `${profitability}%`;
  
  document.getElementById('roomPurchasePrice').value = room.purchasePrice || '';
  document.getElementById('roomTargetProfit').value = room.targetProfit || '';
  
  financialModal.style.display = 'flex';
}

function closeFinancialModal() {
  financialModal.style.display = 'none';
}

function saveRoomFinancialInfo() {
  if (selectedRoomIndex === -1) return;
  
  const purchasePrice = parseFloat(document.getElementById('roomPurchasePrice').value) || 0;
  const targetProfit = parseFloat(document.getElementById('roomTargetProfit').value) || 0;
  
  rooms[selectedRoomIndex].purchasePrice = purchasePrice;
  rooms[selectedRoomIndex].targetProfit = targetProfit;
  
  localStorage.setItem('rooms', JSON.stringify(rooms));
  showRoomFinancialInfo(selectedRoomIndex);
  showNotification('–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
}

function paintBookings() {
  console.log('–û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π');
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —è—á–µ–π–∫–∏
  const cells = document.querySelectorAll('#calendarBody td.cell');
  cells.forEach(cell => {
    // –í–ê–ñ–ù–û: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –¥–∞–Ω–Ω—ã–µ
    const room = cell.dataset.room;
    const day = cell.dataset.day;
    const month = cell.dataset.month;
    const year = cell.dataset.year;
    
    cell.className = 'cell';
    cell.innerHTML = '';
    cell.setAttribute('draggable', 'false');
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    cell.dataset.room = room;
    cell.dataset.day = day;
    cell.dataset.month = month;
    cell.dataset.year = year;
    
    // –í–ê–ñ–ù–û: –ü—Ä–æ—Å—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–Ω–æ–≤–æ
    cell.onclick = function() {
      console.log('–ö–ª–∏–∫ –ø–æ —è—á–µ–π–∫–µ (–≤ paintBookings)', this.dataset);
      openBookingModal(this);
    };
  });
  
  // –û–±–Ω—É–ª—è–µ–º –∑–∞—Ä–∞–±–æ—Ç–æ–∫ –¥–ª—è –≤—Å–µ—Ö –∫–≤–∞—Ä—Ç–∏—Ä
  rooms.forEach(room => {
    room.totalEarned = 0;
    room.monthEarned = 0;
  });
  
  // –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  bookings
    .filter(b => b.month == activeMonth && b.year == activeYear)
    .forEach(b => {
      b.days.forEach(d => {
        // –ò—â–µ–º –≤—Å–µ —è—á–µ–π–∫–∏ —Å –Ω—É–∂–Ω—ã–º –¥–Ω–µ–º –≤ –Ω—É–∂–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
        const row = calendarBody.rows[b.room];
        if (!row) return;
        
        // –ò—â–µ–º —è—á–µ–π–∫—É –≤ —Å—Ç—Ä–æ–∫–µ –ø–æ data-day
        const cell = row.querySelector(`td.cell[data-day="${d}"]`);
        if (!cell) return;
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –ø–æ —Å—Ç–∞—Ç—É—Å—É –æ–ø–ª–∞—Ç—ã
        let paymentClass = 'not-paid';
        if (b.paid === b.total && b.total > 0) {
          paymentClass = 'paid-fully';
        } else if (b.paid > 0 && b.paid < b.total) {
          paymentClass = 'paid-partial';
        }
        
        // –î–ª—è –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∏ —Ç–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–ª–∞—Å—Å—ã
        if (b.status === 'cancelled' || b.status === 'maintenance') {
          paymentClass = b.status;
        }
        
        cell.className = 'cell occupied ' + paymentClass;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ —è—á–µ–π–∫—É
        const nameSpan = document.createElement('span');
        nameSpan.textContent = b.name.length > 8 ? b.name.substring(0, 8) + '...' : b.name;
        
        const paymentSpan = document.createElement('span');
        paymentSpan.className = 'payment-status';
        
        if (b.status === 'cancelled') {
          paymentSpan.textContent = '–û–¢–ú–ï–ù–ê';
        } else if (b.status === 'maintenance') {
          paymentSpan.textContent = '–¢–ï–•.';
        } else if (b.paid === b.total) {
          paymentSpan.textContent = '–û–ü–õ–ê–ß–ï–ù–û';
        } else if (b.paid > 0) {
          paymentSpan.textContent = `–û–ü–õ. ${b.paid}/${b.total}`;
        } else {
          paymentSpan.textContent = '–ù–ï –û–ü–õ';
        }
        
        cell.appendChild(nameSpan);
        cell.appendChild(paymentSpan);
        cell.setAttribute('draggable', 'true');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Ö–æ–¥ –∫ –æ–±—â–µ–π —Å—É–º–º–µ –¥–ª—è —ç—Ç–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã
        if (b.status !== 'cancelled' && b.status !== 'maintenance') {
          const dailyRate = b.total / b.days.length;
          rooms[b.room].totalEarned = (rooms[b.room].totalEarned || 0) + dailyRate;
          rooms[b.room].monthEarned = (rooms[b.room].monthEarned || 0) + dailyRate;
        }
      });
    });
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞—Ä–∞–±–æ—Ç–∫–µ
  localStorage.setItem('rooms', JSON.stringify(rooms));
}

function openBookingModal(cell) {
  console.log('openBookingModal –≤—ã–∑–≤–∞–Ω —Å —è—á–µ–π–∫–æ–π:', cell);
  
  if (!cell) {
    console.error('–Ø—á–µ–π–∫–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ openBookingModal');
    return;
  }
  
  activeCell = cell;
  const r = +cell.dataset.room;
  const d = +cell.dataset.day;
  const m = +cell.dataset.month;
  const y = +cell.dataset.year;
  
  // –ù–∞—Ö–æ–¥–∏–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π —è—á–µ–π–∫–∏
  const exist = bookings.find(b => 
    b.room === r && 
    b.month == m && 
    b.year == y && 
    b.days.includes(d)
  );
  
  if (exist) {
    console.log('–ù–∞–π–¥–µ–Ω–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', exist);
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('guestName').value = exist.name || '';
    document.getElementById('guestPhone').value = exist.phone || '';
    document.getElementById('nightsCount').value = exist.nights || '';
    document.getElementById('totalPrice').value = exist.total || '';
    document.getElementById('paidAmount').value = exist.paid || '';
    document.getElementById('bookingStatus').value = exist.status || 'confirmed';
    document.getElementById('dateFrom').value = exist.from || '';
    document.getElementById('dateTo').value = exist.to || '';
    
    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π –∏–∑ –¥–∞—Ç, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
    if (!exist.nights && exist.from && exist.to) {
      const fromDate = new Date(exist.from);
      const toDate = new Date(exist.to);
      const nights = Math.ceil((toDate - fromDate) / (1000 * 60 * 60 * 24));
      document.getElementById('nightsCount').value = nights;
    }
  } else {
    console.log('–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ');
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –¥–ª—è –Ω–æ–≤–æ–≥–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
    document.getElementById('guestName').value = '';
    document.getElementById('guestPhone').value = '';
    document.getElementById('nightsCount').value = '';
    document.getElementById('totalPrice').value = '';
    document.getElementById('paidAmount').value = '';
    document.getElementById('bookingStatus').value = 'confirmed';
    
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
    const fromDate = new Date(y, m, d);
    const toDate = new Date(y, m, d);
    toDate.setDate(toDate.getDate() + 1);
    
    document.getElementById('dateFrom').value = fromDate.toISOString().split('T')[0];
    document.getElementById('dateTo').value = toDate.toISOString().split('T')[0];
    document.getElementById('nightsCount').value = '1';
  }
  
  // –°–±—Ä–æ—Å –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è –æ–ø—Ü–∏–π
  document.getElementById('repeatBooking').checked = false;
  document.getElementById('repeatOptions').style.display = 'none';
  
  updateRemaining();
  bookingModal.style.display = 'flex';
}

function closeBookingModal() { 
  bookingModal.style.display = 'none'; 
}

function saveBooking() {
  if (!activeCell) {
    alert('–Ø—á–µ–π–∫–∞ –Ω–µ –≤—ã–±—Ä–∞–Ω–∞');
    return;
  }
  
  const room = +activeCell.dataset.room;
  const day = +activeCell.dataset.day;
  const month = +activeCell.dataset.month;
  const year = +activeCell.dataset.year;
  
  const name = document.getElementById('guestName').value.trim();
  const phone = document.getElementById('guestPhone').value.trim();
  const nights = +document.getElementById('nightsCount').value || 1;
  const total = +document.getElementById('totalPrice').value || 0;
  const paid = +document.getElementById('paidAmount').value || 0;
  const status = document.getElementById('bookingStatus').value;
  const from = document.getElementById('dateFrom').value;
  const to = document.getElementById('dateTo').value;
  const repeat = document.getElementById('repeatBooking').checked;
  const repeatType = document.getElementById('repeatType').value;
  const repeatCount = +document.getElementById('repeatCount').value;
  
  if (!name || !phone || !from || !to) {
    alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω, –¥–∞—Ç—ã');
    return;
  }
  
  const d1 = new Date(from), d2 = new Date(to);
  if (d1 > d2) {
    alert('–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è');
    return;
  }
  
  // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ—á–µ–π –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ
  const calculatedNights = Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24));
  
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –º–∞—Å—Å–∏–≤ –¥–Ω–µ–π –º–µ–∂–¥—É –¥–∞—Ç–∞–º–∏
  const days = [];
  const currentDate = new Date(d1);
  while (currentDate <= d2) {
    days.push(currentDate.getDate());
    currentDate.setDate(currentDate.getDate() + 1);
  }
  
  // –ü–æ–ª—É—á–∞–µ–º –º–µ—Å—è—Ü –∏ –≥–æ–¥ –∏–∑ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–∞
  const bookingMonth = d1.getMonth();
  const bookingYear = d1.getFullYear();
  
  console.log('–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', {
    room, bookingMonth, bookingYear, name, days
  });
  
  // –£–¥–∞–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —ç—Ç–∏—Ö –¥–Ω–µ–π
  bookings = bookings.filter(b => {
    // –ï—Å–ª–∏ —ç—Ç–æ —Ç–æ –∂–µ —Å–∞–º–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–ø–æ –Ω–æ–º–µ—Ä—É –∫–æ–º–Ω–∞—Ç—ã, –º–µ—Å—è—Ü—É, –≥–æ–¥—É –∏ –ø–µ—Ä–µ—Å–µ–∫–∞—é—â–∏–º—Å—è –¥–Ω—è–º)
    if (b.room === room && b.month == bookingMonth && b.year == bookingYear) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ –¥–Ω–µ–π
      const hasOverlap = b.days.some(bDay => days.includes(bDay));
      return !hasOverlap;
    }
    return true;
  });
  
  const baseBooking = { 
    room, 
    year: bookingYear, 
    month: bookingMonth, 
    name, 
    phone, 
    nights: calculatedNights,
    total, 
    paid, 
    status,
    from, 
    to, 
    days 
  };
  
  console.log('–°–æ–∑–¥–∞–Ω–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', baseBooking);
  
  if (repeat) {
    saveRecurringBooking(baseBooking, repeatType, repeatCount);
  } else {
    bookings.push(baseBooking);
  }
  
  localStorage.setItem('bookings', JSON.stringify(bookings));
  createBackup(); // –ê–≤—Ç–æ-–±—ç–∫–∞–ø
  closeBookingModal();
  paintBookings();
  calculateStats();
  showNotification('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ');
}

function saveRecurringBooking(baseBooking, repeatType, repeatCount) {
  const bookingsToSave = [baseBooking];
  
  for (let i = 1; i <= repeatCount; i++) {
    const newBooking = {...baseBooking};
    const fromDate = new Date(baseBooking.from);
    const toDate = new Date(baseBooking.to);
    
    if (repeatType === 'weekly') {
      fromDate.setDate(fromDate.getDate() + (7 * i));
      toDate.setDate(toDate.getDate() + (7 * i));
    } else if (repeatType === 'monthly') {
      fromDate.setMonth(fromDate.getMonth() + i);
      toDate.setMonth(toDate.getMonth() + i);
    } else if (repeatType === 'yearly') {
      fromDate.setFullYear(fromDate.getFullYear() + i);
      toDate.setFullYear(toDate.getFullYear() + i);
    }
    
    newBooking.from = fromDate.toISOString().split('T')[0];
    newBooking.to = toDate.toISOString().split('T')[0];
    newBooking.year = fromDate.getFullYear();
    newBooking.month = fromDate.getMonth();
    
    // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–Ω–∏ –¥–ª—è –Ω–æ–≤–æ–≥–æ –º–µ—Å—è—Ü–∞
    const days = [];
    const currentDate = new Date(fromDate);
    const endDate = new Date(toDate);
    while (currentDate <= endDate) {
      days.push(currentDate.getDate());
      currentDate.setDate(currentDate.getDate() + 1);
    }
    newBooking.days = days;
    
    // –£–¥–∞–ª–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±—Ä–æ–Ω–∏ –¥–ª—è —ç—Ç–∏—Ö –¥–Ω–µ–π
    bookings = bookings.filter(b => {
      if (b.room === newBooking.room && b.month == newBooking.month && b.year == newBooking.year) {
        return !b.days.some(day => days.includes(day));
      }
      return true;
    });
    
    bookingsToSave.push(newBooking);
  }
  
  bookingsToSave.forEach(booking => {
    bookings.push(booking);
  });
}

function deleteBooking() {
  if (!activeCell) return;
  
  const room = +activeCell.dataset.room;
  const day = +activeCell.dataset.day;
  const month = +activeCell.dataset.month;
  const year = +activeCell.dataset.year;
  
  console.log('–£–¥–∞–ª–µ–Ω–∏–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', {room, day, month, year});
  
  // –ù–∞—Ö–æ–¥–∏–º –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π —è—á–µ–π–∫–∏
  const bookingIndex = bookings.findIndex(b => {
    const isSameRoom = b.room === room;
    const isSameMonth = b.month == month;
    const isSameYear = b.year == year;
    const includesDay = b.days.includes(day);
    
    return isSameRoom && isSameMonth && isSameYear && includesDay;
  });
  
  if (bookingIndex !== -1) {
    bookings.splice(bookingIndex, 1);
    localStorage.setItem('bookings', JSON.stringify(bookings));
    createBackup(); // –ê–≤—Ç–æ-–±—ç–∫–∞–ø
    closeBookingModal();
    paintBookings();
    calculateStats();
    showNotification('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ');
  } else {
    alert('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–º–µ—Ç–∫–∏ —É–±–æ—Ä–∫–∏
function markCleaningNeeded() {
  const today = new Date();
  const todayDay = today.getDate();
  
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è
  const endingBookings = bookings.filter(b => {
    const toDate = new Date(b.to);
    return toDate.getDate() === todayDay && 
           toDate.getMonth() === today.getMonth() && 
           toDate.getFullYear() === today.getFullYear();
  });
  
  if (endingBookings.length === 0) {
    alert('–°–µ–≥–æ–¥–Ω—è –Ω–µ—Ç –≤—ã–µ–∑–∂–∞—é—â–∏—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤');
    return;
  }
  
  // –ü–æ–º–µ—á–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –∫–∞–∫ —Ç—Ä–µ–±—É—é—â–∏–µ —É–±–æ—Ä–∫–∏
  endingBookings.forEach(booking => {
    if (rooms[booking.room]) {
      rooms[booking.room].needsCleaning = true;
    }
  });
  
  localStorage.setItem('rooms', JSON.stringify(rooms));
  drawCalendar();
  calculateStats();
  showNotification(`–û—Ç–º–µ—á–µ–Ω–æ ${endingBookings.length} –∫–≤–∞—Ä—Ç–∏—Ä –¥–ª—è —É–±–æ—Ä–∫–∏`);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–±–æ—Ä–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
function checkCleaningNeeded() {
  const today = new Date();
  const todayDay = today.getDate();
  
  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å —É–±–æ—Ä–∫–∏ –¥–ª—è –≤—Å–µ—Ö –∫–≤–∞—Ä—Ç–∏—Ä
  rooms.forEach(room => {
    room.needsCleaning = false;
  });
  
  // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è —Å–µ–≥–æ–¥–Ω—è
  const endingBookings = bookings.filter(b => {
    const toDate = new Date(b.to);
    return toDate.getDate() === todayDay && 
           toDate.getMonth() === today.getMonth() && 
           toDate.getFullYear() === today.getFullYear();
  });
  
  // –ü–æ–º–µ—á–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã –∫–∞–∫ —Ç—Ä–µ–±—É—é—â–∏–µ —É–±–æ—Ä–∫–∏
  endingBookings.forEach(booking => {
    if (rooms[booking.room]) {
      rooms[booking.room].needsCleaning = true;
    }
  });
  
  localStorage.setItem('rooms', JSON.stringify(rooms));
}

// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫
function filterRooms() {
  const search = document.getElementById('searchRoom').value.toLowerCase();
  const status = document.getElementById('statusFilter').value;
  const category = document.getElementById('categoryFilter').value;
  
  document.querySelectorAll('#calendarBody tr').forEach((row, i) => {
    const room = rooms[i];
    if (!room) return;
    
    const roomName = room.name.toLowerCase();
    const roomCategory = room.category;
    const hasBooking = row.querySelector('.occupied');
    const needsCleaning = room.needsCleaning;
    
    let show = true;
    if (search && !roomName.includes(search)) show = false;
    if (status === 'free' && hasBooking) show = false;
    if (status === 'booked' && !hasBooking) show = false;
    if (status === 'cleaning' && !needsCleaning) show = false;
    if (category !== 'all' && roomCategory !== category) show = false;
    
    row.style.display = show ? '' : 'none';
  });
}

// –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
function calculateStats() {
  const daysInMonth = new Date(activeYear, activeMonth + 1, 0).getDate();
  const totalDays = rooms.length * daysInMonth;
  let bookedDays = 0;
  let expectedIncome = 0;
  let totalBookingsSet = new Set();
  let cleaningCount = 0;
  
  // –°—á–∏—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
  const currentMonthBookings = bookings.filter(b => 
    b.month == activeMonth && b.year == activeYear
  );
  
  currentMonthBookings.forEach(b => {
    bookedDays += b.days.length;
    expectedIncome += b.total;
    totalBookingsSet.add(`${b.room}-${b.name}-${b.from}`);
  });
  
  // –°—á–∏—Ç–∞–µ–º –∫–≤–∞—Ä—Ç–∏—Ä—ã, —Ç—Ä–µ–±—É—é—â–∏–µ —É–±–æ—Ä–∫–∏
  cleaningCount = rooms.filter(room => room.needsCleaning).length;
  
  const occupancyRate = totalDays > 0 ? ((bookedDays / totalDays) * 100).toFixed(1) : 0;
  document.getElementById('occupancyRate').textContent = `${occupancyRate}%`;
  document.getElementById('expectedIncome').textContent = `${expectedIncome} ‚ÇΩ`;
  document.getElementById('totalBookings').textContent = totalBookingsSet.size;
  document.getElementById('cleaningCount').textContent = cleaningCount;
}

// –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
function checkUpcomingBookings() {
  const today = new Date();
  const nextWeek = new Date(today);
  nextWeek.setDate(nextWeek.getDate() + 7);
  
  const upcoming = bookings.filter(b => {
    const bookingDate = new Date(b.from);
    return bookingDate >= today && bookingDate <= nextWeek;
  });
  
  if (upcoming.length > 0) {
    showNotification(`–ù–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ ${upcoming.length} –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π`);
  }
}

function showNotification(message) {
  // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 5000);
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –±—Ä–∞—É–∑–µ—Ä–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('–ö–∞–ª–µ–Ω–¥–∞—Ä—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', {
      body: message,
      icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%234caf50"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>'
    });
  }
}

// Drag & Drop
function initDragAndDrop() {
  document.querySelectorAll('.cell').forEach(cell => {
    cell.addEventListener('dragstart', (e) => {
      if (cell.classList.contains('occupied')) {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          room: cell.dataset.room,
          day: cell.dataset.day,
          month: cell.dataset.month,
          year: cell.dataset.year
        }));
      }
    });
    
    cell.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    
    cell.addEventListener('drop', (e) => {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      if (data) {
        moveBooking(data.room, data.day, data.month, data.year, 
                   cell.dataset.room, cell.dataset.day, cell.dataset.month, cell.dataset.year);
      }
    });
  });
}

function moveBooking(fromRoom, fromDay, fromMonth, fromYear, toRoom, toDay, toMonth, toYear) {
  fromRoom = +fromRoom;
  fromDay = +fromDay;
  fromMonth = +fromMonth;
  fromYear = +fromYear;
  toRoom = +toRoom;
  toDay = +toDay;
  toMonth = +toMonth;
  toYear = +toYear;
  
  // –ù–∞–π—Ç–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  const bookingIndex = bookings.findIndex(b => 
    b.room === fromRoom && b.month == fromMonth && 
    b.year == fromYear && b.days.includes(fromDay)
  );
  
  if (bookingIndex !== -1) {
    const booking = bookings[bookingIndex];
    
    // –í—ã—á–∏—Å–ª–∏—Ç—å —Å–º–µ—â–µ–Ω–∏–µ –¥–Ω–µ–π
    const dayDiff = toDay - fromDay;
    const monthDiff = toMonth - fromMonth;
    const yearDiff = toYear - fromYear;
    
    // –û–±–Ω–æ–≤–∏—Ç—å –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
    booking.days = booking.days.map(d => d + dayDiff);
    booking.room = toRoom;
    booking.month = toMonth;
    booking.year = toYear;
    
    // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞—Ç—ã
    const fromDate = new Date(booking.from);
    const toDate = new Date(booking.to);
    fromDate.setDate(fromDate.getDate() + dayDiff);
    fromDate.setMonth(fromDate.getMonth() + monthDiff);
    fromDate.setFullYear(fromDate.getFullYear() + yearDiff);
    
    toDate.setDate(toDate.getDate() + dayDiff);
    toDate.setMonth(toDate.getMonth() + monthDiff);
    toDate.setFullYear(toDate.getFullYear() + yearDiff);
    
    booking.from = fromDate.toISOString().split('T')[0];
    booking.to = toDate.toISOString().split('T')[0];
    
    localStorage.setItem('bookings', JSON.stringify(bookings));
    paintBookings();
    showNotification('–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–æ');
  }
}

// –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ
function createBackup() {
  const data = {
    rooms: rooms,
    bookings: bookings,
    timestamp: new Date().toISOString()
  };
  
  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
  const backupKey = 'backup_' + new Date().toISOString().replace(/[:.]/g, '-');
  localStorage.setItem(backupKey, JSON.stringify(data));
  
  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10)
  const backups = Object.keys(localStorage)
    .filter(key => key.startsWith('backup_'))
    .sort()
    .reverse();
    
  if (backups.length > 10) {
    for (let i = 10; i < backups.length; i++) {
      localStorage.removeItem(backups[i]);
    }
  }
  
  showNotification('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞');
}

function restoreBackup() {
  const backups = Object.keys(localStorage)
    .filter(key => key.startsWith('backup_'))
    .sort()
    .reverse();
    
  if (backups.length === 0) {
    alert('–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
    return;
  }
  
  const backupList = backups.map((key, i) => 
    `${i+1}. ${new Date(key.replace('backup_', '')).toLocaleString()}`
  ).join('\n');
  
  const choice = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è:\n\n${backupList}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä:`);
  const index = parseInt(choice) - 1;
  
  if (index >= 0 && index < backups.length) {
    const backup = JSON.parse(localStorage.getItem(backups[index]));
    rooms = backup.rooms;
    bookings = backup.bookings;
    localStorage.setItem('rooms', JSON.stringify(rooms));
    localStorage.setItem('bookings', JSON.stringify(bookings));
    drawCalendar();
    showNotification('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏');
  }
}

// –≠–∫—Å–ø–æ—Ä—Ç
function exportToCSV() {
  let csv = '–ö–≤–∞—Ä—Ç–∏—Ä–∞,–î–µ–Ω—å,–ú–µ—Å—è—Ü,–ì–æ–¥,–ò–º—è,–¢–µ–ª–µ—Ñ–æ–Ω,–°—Ç–∞—Ç—É—Å,–û–ø–ª–∞—á–µ–Ω–æ,–í—Å–µ–≥–æ,–î–∞—Ç–∞ –∑–∞–µ–∑–¥–∞,–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞\n';
  bookings.forEach(b => {
    b.days.forEach(d => {
      const roomName = rooms[b.room]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      csv += `${roomName},${d},${+b.month + 1},${b.year},${b.name},${b.phone},${b.status},${b.paid},${b.total},${b.from},${b.to}\n`;
    });
  });
  
  downloadFile(csv, `–±—Ä–æ–Ω–∏_${activeYear}_${activeMonth+1}.csv`, 'text/csv;charset=utf-8;');
  showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ CSV');
}

function exportToGoogleCalendar() {
  const events = bookings.map(b => {
    const start = new Date(b.year, b.month, b.days[0]);
    const end = new Date(b.year, b.month, b.days[b.days.length - 1]);
    end.setDate(end.getDate() + 1);
    
    const roomName = rooms[b.room]?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    
    return {
      title: `–ë—Ä–æ–Ω—å: ${roomName} - ${b.name}`,
      start: start.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z',
      end: end.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z',
      description: `–¢–µ–ª–µ—Ñ–æ–Ω: ${b.phone}\n–°—É–º–º–∞: ${b.total}‚ÇΩ\n–û–ø–ª–∞—á–µ–Ω–æ: ${b.paid}‚ÇΩ\n–°—Ç–∞—Ç—É—Å: ${b.status}`
    };
  });
  
  const icsContent = generateICS(events);
  downloadFile(icsContent, 'bookings.ics', 'text/calendar');
  showNotification('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä—å');
}

function generateICS(events) {
  let ics = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Booking Calendar//RU\n';
  
  events.forEach(event => {
    ics += 'BEGIN:VEVENT\n';
    ics += `DTSTART:${event.start}\n`;
    ics += `DTEND:${event.end}\n`;
    ics += `SUMMARY:${event.title}\n`;
    ics += `DESCRIPTION:${event.description.replace(/\n/g, '\\n')}\n`;
    ics += `UID:${Math.random().toString(36).substr(2, 9)}@booking\n`;
    ics += 'END:VEVENT\n';
  });
  
  ics += 'END:VCALENDAR';
  return ics;
}

function downloadFile(content, fileName, mimeType) {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = fileName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function toggleRepeatOptions() {
  const repeatOptions = document.getElementById('repeatOptions');
  repeatOptions.style.display = document.getElementById('repeatBooking').checked ? 'block' : 'none';
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞ —Å—É–º–º—ã
const totalInput = document.getElementById('totalPrice');
const paidInput = document.getElementById('paidAmount');
const remainingDiv = document.getElementById('remainingAmount');

function updateRemaining() {
  const total = Number(totalInput.value) || 0;
  const paid = Number(paidInput.value) || 0;
  const remaining = total - paid;
  remainingDiv.textContent = '–û—Å—Ç–∞–ª–æ—Å—å: ' + remaining + ' ‚ÇΩ';
  
  if (remaining > 0) {
    remainingDiv.style.color = '#ef4444';
  } else if (remaining === 0) {
    remainingDiv.style.color = '#10b981';
  } else {
    remainingDiv.style.color = '#f59e0b';
  }
}

totalInput.addEventListener('input', updateRemaining);
paidInput.addEventListener('input', updateRemaining);

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
yearSel.onchange = () => drawCalendar(monthSel.value, yearSel.value);
monthSel.onchange = () => drawCalendar(monthSel.value, yearSel.value);
bookingModal.onclick = e => { if (e.target === bookingModal) closeBookingModal(); };
renameModal.onclick = e => { if (e.target === renameModal) closeRenameModal(); };
financialModal.onclick = e => { if (e.target === financialModal) closeFinancialModal(); };

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', () => {
  init();
  checkCleaningNeeded();
});
</script>
</body>
</html>
